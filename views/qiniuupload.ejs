<!DOCTYPE html>
<body>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="//apps.bdimg.com/libs/jqueryui/1.10.4/css/jquery-ui.min.css">
  <script src="//apps.bdimg.com/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="jqueryui/style.css">
  <style>
  .ui-progressbar {
    position: relative;
  }
  .progress-label {
    position: absolute;
    left: 50%;
    top: 4px;
    font-weight: bold;
    text-shadow: 1px 1px 0 #fff;
  }
  </style>
  <script>
  $(document).ready(function() {
    $("#progressbar").hide();
    var Qiniu_UploadUrl = "http://up.qiniu.com";
    var progressbar = $("#progressbar"),
        progressLabel = $(".progress-label");
    progressbar.progressbar({
        value: false,
        change: function() {
            progressLabel.text(progressbar.progressbar("value") + "%");
        },
        complete: function() {
            progressLabel.text("Complete!");
        }
    });
    $("button").click(function() {
    //$("#btn_upload").click(function() {
        $("#progressbar").show();
        //普通上传
        var Qiniu_upload = function(f, token) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', Qiniu_UploadUrl, true);
            var formData, startDate;
            formData = new FormData();
            formData.append('token', token);
            formData.append('file', f);
            formData.append('key', '<%= filePath %>-'+f.name);

            var taking;
            xhr.upload.addEventListener("progress", function(evt) {
                if (evt.lengthComputable) {
                    var nowDate = new Date().getTime();
                    taking = nowDate - startDate;
                    var x = (evt.loaded) / 1024;
                    var y = taking / 1000;
                    var uploadSpeed = (x / y);
                    var formatSpeed;
                    if (uploadSpeed > 1024) {
                        formatSpeed = (uploadSpeed / 1024).toFixed(2) + "Mb\/s";
                    } else {
                        formatSpeed = uploadSpeed.toFixed(2) + "Kb\/s";
                    }
                    var percentComplete = Math.round(evt.loaded * 100 / evt.total);
                    progressbar.progressbar("value", percentComplete);
                    // console && console.log(percentComplete, ",", formatSpeed);
                }
            }, false);
            xhr.onreadystatechange = function(response) {
                if (xhr.readyState == 4 && xhr.status == 200 && xhr.responseText != "") {
                    var blkRet = JSON.parse(xhr.responseText);
                    console && console.log(blkRet);
                    $("#dialog").html(xhr.responseText).dialog();
                } else if (xhr.status != 200 && xhr.responseText) {

                }
            };
            xhr.onload = function(e) {
                var retjson = JSON.parse(xhr.response);
                if (xhr.status == 200) {
                    $('#qiniufile').val(retjson.key);
                }
            };
            startDate = new Date().getTime();
            $("#progressbar").show();
            xhr.send(formData);
        };
        var token = $("#token").val();
        if ($("#file")[0].files.length > 0 && token != "") {
            Qiniu_upload($("#file")[0].files[0], token);
        } else {
            console && console.log("form input error");
        }
    })
})
  </script>
</head>
<body>
 <form action="/nownessvideo" method="POST">
<ul>
        <input id="token" name="token" type="hidden" value="<%= uploadToken %>" />
        <input id="qiniufile" name="qiniufile" type="hidden" value="" />
    </li>
    <li>
        <label for="nownessid">NOWNESS id:</label>
        <input id="nownessid" name="nownessid" class="ipt" type="input" />
    </li>
    <li>
        <label for="title">NOWNESS账号:</label>
        <input id="nownessname" name="nownessname" class="ipt" type="input" />
    </li>
    <li>
        <label for="title">title:</label>
        <input id="title" name="title" class="ipt" type="input" />
    </li>
    <li>
        <label for="subtitle">副标题:</label>
        <input id="subtitle" name="subtitle" class="ipt" type="input" />
    </li>
    <li>
        <label for="category">分类:</label>
            <select name="category">
                    <option value ="1" selected="selected">文化</option>
                    <option value ="2">美食与旅行</option>
                    <option value="3">艺术与设计</option>
                    <option value="4">音乐</option>
                    <option value="5">时尚与美容</option>
            </select>
    </li>
    <li>
        <label for="keyword">关键字:</label>
        <input id="keyword" name="keyword" class="ipt" type="input" />
    </li>
    <li>
        <label for="email">邮箱:</label>
        <input id="email" name="email" class="ipt" type="input" />
    </li>
    <li>
        <label for="debut">首映:</label>
        <label><input id="debut" name="debut" class="ipt" type="radio" value=1 checked/>是</label>
        <label><input id="debut" name="debut" class="ipt" type="radio" value=0 />否</label>
    </li>
    <li>
        <label for="extvideourl">视频连接:</label>
        <input id="extvideourl" name="extvideourl" class="ipt" type="input" />
    </li>
    <li>
        <label for="bucket">视频文件:</label>
        <input id="file" name="file" class="ipt" type="file" />
       <script>
       $( "button" ).button();
       </script>
        <button>上传文件</button>
    </li>
    <li>
        <label for="content">内容:</label>
        <textarea name="content" cols="30" rows="4"></textarea>
    </li>
    <li>
        <input id="btn_upload" type="submit" value="提交">
    </li>
    <div id="progressbar"><div class="progress-label"></div></div>
</ul>
</form>

</body>
</html>